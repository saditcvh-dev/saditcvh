<app-toast [toast]="toast()" (close)="closeToast()"></app-toast>

<div class="min-h-screen ">
  <!-- Header con Logo y Tabs -->
  <header>
    <div class=" mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Logo y Titulo -->
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center space-x-3">

          <div>
            <h1 class="text-xl font-bold text-[#691831] dark:text-[#c44569]">Digitalización</h1>
            <p class="text-xs text-gray-500 dark:text-gray-400">Procesamiento OCR</p>
          </div>
        </div>

        <!-- Estadisticas y Actualizar -->
        <div class="flex items-center space-x-6">
          <div class="hidden md:flex items-center space-x-4 text-sm">
            <span class="text-gray-600 dark:text-gray-400">Total: <span
                class="font-semibold text-gray-900 dark:text-gray-100">{{ totalPdfsCount
                }}</span></span>
            <span class="text-gray-600 dark:text-gray-400">Completados: <span class="font-semibold text-green-600">{{
                completedPdfsCount()
                }}</span></span>
            <span class="text-gray-600 dark:text-gray-400">En proceso: <span class="font-semibold text-yellow-600">{{
                processingPdfsCount()
                }}</span></span>
          </div>


          <button (click)="loadPdfsList()"
            class="px-4 py-2 border-2 border-[#691831]  text-[#691831] rounded-lg hover:bg-[#691831]/10 dark:border-[#c44569] dark:text-[#c44569] dark:hover:bg-[#c44569]/20 transition-colors flex items-center space-x-2 font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            <span>Actualizar</span>
          </button>
        </div>
      </div>

      <!-- Tabs Navigation -->
      <nav class="flex space-x-1 border-t border-gray-100 pt-2 dark:border-neutral-800">
        <button (click)="activeTab = 'upload'"
          [class]="activeTab === 'upload' ? 'border-b-2 border-[#691831] text-[#691831] dark:border-[#c44569] dark:text-[#c44569]' : 'text-gray-500 hover:text-[#A02142] dark:hover:text-[#c44569]'"
          class="px-4 py-3 text-sm font-medium transition-colors flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 16v-8m0 0l-3 3m3-3l3 3M20 16.5a4.5 4.5 0 00-4.5-4.5h-.75A6.75 6.75 0 105.25 18h8.5" />
          </svg>
          <span>Subir PDF</span>
        </button>

        <button (click)="activeTab = 'search'"
          [class]="activeTab === 'search' ? 'border-b-2 border-[#691831] text-[#691831] dark:border-[#c44569] dark:text-[#c44569]' : 'text-gray-500 hover:text-[#A02142] dark:hover:text-[#c44569]'"
          class="px-4 py-3 text-sm font-medium transition-colors flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
          </svg>
          <span>Buscar en PDFs</span>
        </button>

        <!-- <button (click)="activeTab = 'quick'"
          [class]="activeTab === 'quick' ? 'border-b-2 border-[#691831] text-[#691831] dark:border-[#c44569] dark:text-[#c44569]' : 'text-gray-500 hover:text-[#A02142] dark:hover:text-[#c44569]'"
          class="px-4 py-3 text-sm font-medium transition-colors flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zm-7.518-.267A8.25 8.25 0 1120.25 10.5M8.288 14.212A5.25 5.25 0 1117.25 10.5" />
          </svg>
          <span>Busqueda Rapida</span>
        </button> -->

        <button (click)="activeTab = 'global'"
          [class]="activeTab === 'global' ? 'border-b-2 border-[#691831] text-[#691831] dark:border-[#c44569] dark:text-[#c44569]' : 'text-gray-500 hover:text-[#A02142] dark:hover:text-[#c44569]'"
          class="px-4 py-3 text-sm font-medium transition-colors flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
          </svg>
          <span>Busqueda Global</span>
        </button>

        <button (click)="activeTab = 'files'"
          [class]="activeTab === 'files' ? 'border-b-2 border-[#691831] text-[#691831] dark:border-[#c44569] dark:text-[#c44569]' : 'text-gray-500 hover:text-[#A02142] dark:hover:text-[#c44569]'"
          class="px-4 py-3 text-sm font-medium transition-colors flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
          </svg>
          <span>Archivos ({{ totalPdfsCount }})</span>
        </button>
        <button (click)="activeTab = 'lotes'"
          [class]="activeTab === 'lotes' ? 'border-b-2 border-[#691831] text-[#691831] dark:border-[#c44569] dark:text-[#c44569]' : 'text-gray-500 hover:text-[#A02142] dark:hover:text-[#c44569]'"
          class="px-4 py-3 text-sm font-medium transition-colors flex items-center space-x-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
          </svg>
          <!-- <span>Procesos de carga </span> -->
           <span>Procesos de carga ({{ totalArchivosLotes() }})</span>
        </button>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- UPLOAD SECTION -->
    <!-- UPLOAD SECTION -->
    <section *ngIf="activeTab === 'upload'" class="space-y-6">
      <app-upload-section [recentUploads]="recentUploads" (uploadCompleted)="onUploadCompleted()"
        (recentUploadsChange)="recentUploads = $event">
      </app-upload-section>
    </section>

    <!-- SEARCH SECTION -->
    <section *ngIf="activeTab === 'search'" class="space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- PDF Selection -->
        <div class="lg:col-span-1">
          <div
            class="bg-white dark:bg-[#1a1a1b] border border-gray-200 dark:border-neutral-800 rounded-xl shadow-sm p-6 border border-gray-200">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4 flex items-center">
              <svg class="w-6 h-6 text-[#691831] dark:text-[#c44569] mr-3" fill="none" stroke="currentColor"
                stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375" />
              </svg>
              Seleccionar PDF
            </h3>

            <div class="relative mb-4">
              <select [(ngModel)]="selectedPdfId" (change)="onPdfSelect(selectedPdfId)" class="
      w-full p-4 pl-12 rounded-xl border-2 appearance-none
      bg-white dark:bg-[#131314]
      border-gray-300 dark:border-neutral-700

      !text-gray-900 dark:!text-neutral-100
      caret-gray-900 dark:caret-neutral-100

      focus:ring-2 focus:ring-[#BC955B]
      focus:border-[#BC955B]
      dark:focus:ring-[#d4a762]
      dark:focus:border-[#d4a762]

      transition-colors font-medium
    ">
                <option value="" class="bg-white dark:bg-[#131314] text-gray-400 dark:text-neutral-400">
                  -- Selecciona un PDF --
                </option>

                <option *ngFor="let pdf of pdfsList" [value]="pdf.id"
                  class="bg-white dark:bg-[#131314] text-gray-900 dark:text-neutral-100">
                  {{ pdf.filename }} ({{ pdf.pages }} pags.)
                </option>
              </select>

              <div
                class="absolute left-4 top-1/2 -translate-y-1/2 text-[#691831] dark:text-[#c44569] pointer-events-none">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5" />
                </svg>
              </div>
            </div>

            <!-- PDF Info -->
            <div *ngIf="selectedPdfInfo" class="p-4 bg-gray-50 dark:bg-[#131314] rounded-xl border border-gray-200">
              <h4 class="font-bold text-gray-900 dark:text-gray-100 mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" stroke-width="2"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                </svg>
                Informacion
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Subido:</span>
                  <span class="font-semibold text-gray-900 dark:text-gray-100">{{
                    formatDate(selectedPdfInfo.upload_date.toString())
                    }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Tamano:</span>
                  <span class="font-semibold text-gray-900 dark:text-gray-100">{{ formatBytes(selectedPdfInfo.size)
                    }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Texto extraido:</span>
                  <span class="font-semibold" [class]="selectedPdfInfo.has_text ? 'text-green-600' : 'text-yellow-600'">
                    {{ selectedPdfInfo.has_text ? 'Disponible' : 'No disponible' }}
                  </span>
                </div>
                <div class="flex flex-col space-y-2 mt-4 pt-3 border-t border-gray-200">
                  <button (click)="viewText(selectedPdfInfo!.id)"
                    class="w-full px-3 py-2 text-sm border-2 border-[#691831] text-[#691831] rounded-lg hover:bg-[#691831]/10 dark:border-[#c44569] dark:text-[#c44569] dark:hover:bg-[#c44569]/20 transition-colors font-medium">
                    Ver texto
                  </button>
                  <button (click)="downloadText(selectedPdfInfo!.id)"
                    class="w-full px-3 py-2 text-sm border-2 border-[#691831] text-[#691831] dark:border-[#c44569] dark:text-[#c44569] rounded-lg hover:bg-green-50 transition-colors font-medium">
                    Descargar TXT
                  </button>
                  <button (click)="downloadSearchablePDF(selectedPdfInfo!.id)"
                    class="w-full px-3 py-2 text-sm border-2 border-[#691831] text-[#691831] rounded-lg hover:bg-[#691831]/10 dark:border-[#c44569] dark:text-[#c44569] dark:hover:bg-[#c44569]/20 transition-colors font-medium">
                    Descargar PDF con texto
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Search Form and Results -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Search Form -->
          <div
            class="bg-white dark:bg-[#1a1a1b] rounded-xl shadow-sm p-6 border border-gray-200 dark:border-neutral-700 dark:bg-[#1a1a1b] dark:border-neutral-800">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">Buscar en documento</h3>
            <div class="space-y-4">
              <div class="relative">
                <input type="text" [(ngModel)]="searchTerm" placeholder="Escribe el texto a buscar..." class="
                w-full p-4 pl-12 rounded-xl border-2
                bg-white dark:bg-[#131314]
                border-gray-300 dark:border-neutral-700

                !text-gray-900 dark:!text-neutral-100
                caret-gray-900 dark:caret-neutral-100

                placeholder:text-gray-400 dark:placeholder:text-neutral-400

                focus:ring-2 focus:ring-[#BC955B]
                focus:border-[#BC955B]
                dark:focus:ring-[#d4a762]
                dark:focus:border-[#d4a762]

                transition-colors
              " />

                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-[#691831] dark:text-[#c44569]">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                  </svg>
                </div>
              </div>

              <div class="flex items-center justify-between">
                <label class="flex items-center space-x-3 cursor-pointer">
                  <div class="relative">
                    <input type="checkbox" [(ngModel)]="caseSensitive" class="sr-only peer" />

                    <!-- Track -->
                    <div class="
      w-11 h-6 rounded-full transition-colors
      bg-gray-300 dark:bg-neutral-600
      peer-checked:bg-[#691831] dark:peer-checked:bg-[#c44569]
    "></div>

                    <!-- Thumb -->
                    <div class="
      absolute left-1 top-1 w-4 h-4 rounded-full
      bg-white dark:bg-neutral-100
      transition-transform
      peer-checked:translate-x-5
    "></div>
                  </div>
                  <span class="text-gray-700 dark:text-gray-300 font-medium">Coincidir mayusculas/minusculas</span>
                </label>
                <button (click)="searchInPdf()" [disabled]="!selectedPdfId || !searchTerm.trim() || isSearching()"
                  class="px-6 py-3 border-2  bg-[#691831] text-white dark:bg-[#c44569] font-semibold rounded-xl  hover:border-[#A02142] dark:hover:border-[#d4708a] disabled:border-gray-300 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center space-x-2">
                  <span *ngIf="!isSearching()">Buscar</span>
                  <span *ngIf="isSearching()" class="flex items-center space-x-2">
                    <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>Buscando...</span>
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- Search Results -->
          <div *ngIf="searchResults" class="bg-white dark:bg-[#1a1a1b] rounded-xl shadow-sm 
            border border-gray-200 dark:border-neutral-800 overflow-hidden">
            <div class="bg-[#691831] dark:bg-[#c44569] p-5">
              <div class="flex justify-between items-center">
                <h4 class="font-bold text-white text-lg">Resultados: "{{ searchResults.term }}"</h4>
                <div class="flex items-center space-x-3 bg-white/20 px-4 py-2 rounded-full">
                  <span class="text-sm font-semibold text-white">{{ searchResults.total_matches }} coincidencias</span>
                  <span class="text-xs text-white/80">{{ searchResults.execution_time | number:'1.3-3' }}s</span>
                </div>
              </div>
            </div>

            <div class="p-6">
              <div *ngIf="searchResults.results.length > 0" class="space-y-3 max-h-[500px] overflow-y-auto">
                <div *ngFor="let result of searchResults.results; let i = index"
                  class="p-4 bg-gray-50 dark:bg-[#131314] border-2 border-gray-200 rounded-xl hover: transition-all">
                  <div class="flex justify-between items-start mb-3">
                    <span
                      class="inline-flex items-center px-3 py-1 text-xs font-bold border-2 border-[#691831] text-[#691831] rounded-full">
                      Pagina {{ result.page }}
                      <span class="ml-2 bg-[#691831] text-white dark:bg-[#c44569] text-xs px-2 py-0.5 rounded-full">{{ i
                        + 1 }}</span>
                    </span>
                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Pos: {{ result.position }}</span>
                  </div>
                  <p class="text-gray-800 dark:text-gray-200 leading-relaxed">
                    ...<span
                      class="bg-[#BC955B]/30 text-[#691831] dark:bg-[#BC955B]/20 dark:text-[#f1c27d] px-1.5 py-0.5 rounded font-semibold">{{
                      result.context }}</span>...
                  </p>
                </div>
              </div>

              <div *ngIf="searchResults.total_matches === 0" class="text-center py-12">
                <div
                  class="w-20 h-20 mx-auto mb-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                  <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
                  </svg>
                </div>
                <p class="text-gray-600 dark:text-gray-400 font-medium">No se encontraron coincidencias</p>
                <p class="text-sm text-gray-500 mt-2">Intenta con otros terminos de busqueda</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- QUICK SEARCH SECTION -->
    <section *ngIf="activeTab === 'quick'" class="space-y-6">
      <div class="max-w-4xl mx-auto space-y-6">
        <!-- File Upload -->
        <div
          class="bg-white dark:bg-[#1a1a1b] rounded-xl shadow-sm p-8 border-2 border-dashed border-gray-300 dark:border-neutral-700">
          <div
            class="rounded-xl p-12 text-center transition-all cursor-pointer group hover:bg-[#691831]/10 dark:hover:bg-[#c44569]/20 dark:text-[#c44569]:text-[#c44569] dark:hover:bg-[#c44569]/20/30 cursor-pointer group"
            (click)="quickFileInput.click()">
            <input #quickFileInput type="file" accept=".pdf" class="hidden" (change)="onQuickFileSelected($event)" />
            <div class="text-[#691831] dark:text-[#c44569] mb-4 group-hover:scale-110 transition-transform">
              <svg class="w-24 h-24 mx-auto" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 16v-8m0 0l-3 3m3-3l3 3M20 16.5a4.5 4.5 0 00-4.5-4.5h-.75A6.75 6.75 0 105.25 18h8.5" />
              </svg>
            </div>
            <h3 class="text-xl font-bold text-[#691831] dark:text-[#c44569] mb-2">{{ quickSearchFile?.name ||
              'Selecciona un archivo PDF' }}
            </h3>
            <p class="text-gray-600 dark:text-gray-400">Busqueda instantanea sin guardar el archivo</p>
          </div>
        </div>

        <!-- Search Options -->
        <div class="bg-white dark:bg-[#1a1a1b] rounded-xl shadow-sm p-6 border border-gray-200 dark:border-neutral-700">
          <div class="space-y-4">
            <div class="relative">
              <input type="text" [(ngModel)]="quickSearchTerm" placeholder="Texto a buscar..." class="    w-full p-4 pl-12 rounded-xl border-2
    bg-white dark:bg-[#131314]
    border-gray-300 dark:border-neutral-700

    !text-gray-900 dark:!text-neutral-100
    caret-gray-900 dark:caret-neutral-100

    placeholder:text-gray-400 dark:placeholder:text-neutral-400

    focus:ring-2 focus:ring-[#BC955B]
    focus:border-[#BC955B]
    dark:focus:ring-[#d4a762]
    dark:focus:border-[#d4a762]

    transition-colors" />
              <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-[#691831] dark:text-[#c44569]">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <label class="flex items-center space-x-3 cursor-pointer">
                <div class="relative">
                  <input type="checkbox" [(ngModel)]="quickUseOcr" class="sr-only peer" />
                  <div class="    w-11 h-6 rounded-full transition-colors
    bg-gray-300 dark:bg-neutral-600
    peer-checked:bg-[#691831]
    dark:peer-checked:bg-[#c44569]">
                  </div>
                  <div
                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5">
                  </div>
                </div>
                <span class="text-gray-700 dark:text-gray-300 font-medium">Usar OCR para texto en imagenes</span>
              </label>

              <button (click)="quickSearch()"
                [disabled]="!quickSearchFile || !quickSearchTerm.trim() || isQuickSearching()"
                class="px-8 py-3 border-2  bg-[#691831] text-white dark:bg-[#c44569] font-bold rounded-xl  hover:border-[#A02142] dark:hover:border-[#d4708a] disabled:border-gray-300 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center space-x-2">
                <span *ngIf="!isQuickSearching()">Buscar</span>
                <span *ngIf="isQuickSearching()" class="flex items-center space-x-2">
                  <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  <span>Buscando...</span>
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Search Results -->
        <div *ngIf="quickSearchResults" class="bg-white dark:bg-[#1a1a1b] rounded-xl shadow-sm 
            border border-gray-200 dark:border-neutral-800 overflow-hidden">
          <div class="bg-green-500 p-5">
            <div class="flex justify-between items-center">
              <h4 class="font-bold text-white text-lg">Resultados: "{{ quickSearchResults.term }}"</h4>
              <div class="flex items-center space-x-3 bg-white/20 dark:bg-black/20 px-4 py-2 rounded-full">
                <span class="text-sm font-semibold text-white">{{ quickSearchResults.total_matches }}
                  coincidencias</span>
                <span class="text-xs text-white/80">{{ quickSearchResults.execution_time | number:'1.3-3' }}s</span>
              </div>
            </div>
          </div>

          <div class="p-6">
            <div *ngIf="quickSearchResults.results.length > 0" class="space-y-3 max-h-[500px] overflow-y-auto">
              <div *ngFor="let result of quickSearchResults.results"
                class="p-4 bg-green-50 border-2 border-green-200 rounded-xl hover:border-green-400 transition-all">
                <div class="mb-3">
                  <span
                    class="inline-flex items-center px-3 py-1 text-xs font-bold border-2 border-green-500 text-green-600 rounded-full">
                    Pagina {{ result.page }}
                  </span>
                </div>
                <p class="text-gray-800 dark:text-gray-200 leading-relaxed">
                  ...<span
                    class="bg-[#BC955B]/30 text-[#691831] dark:bg-[#BC955B]/20 dark:text-[#f1c27d] px-1.5 py-0.5 rounded font-semibold">{{
                    result.context }}</span>...
                </p>
              </div>
            </div>

            <div *ngIf="quickSearchResults.total_matches === 0" class="text-center py-12">
              <div
                class="w-20 h-20 mx-auto mb-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
                </svg>
              </div>
              <p class="text-gray-600 dark:text-gray-400 font-medium">No se encontraron coincidencias</p>
              <p class="text-sm text-gray-500 mt-2">Intenta con otros terminos o activa OCR</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- GLOBAL SEARCH SECTION -->
    <section *ngIf="activeTab === 'global'" class="space-y-6">
      <div class="max-w-5xl mx-auto space-y-6">
        <!-- Search Form -->
        <div class="bg-white dark:bg-[#1a1a1b] rounded-xl shadow-sm p-8 border border-gray-200 dark:border-neutral-700">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
              <label
                class="block text-sm font-bold text-gray-900 dark:text-gray-100 mb-3 uppercase tracking-wide">Termino de
                busqueda</label>
              <div class="relative">
                <input type="text" [(ngModel)]="globalSearchTerm" placeholder="Buscar en todos los documentos..."
                  class="w-full p-4 pl-12 rounded-xl border-2 text-lg bg-white dark:bg-[#131314] border-gray-300 dark:border-neutral-700 !text-gray-900 dark:!text-neutral-100 caret-gray-900 dark:caret-neutral-100 placeholder:text-gray-400 dark:placeholder:text-neutral-400 focus:ring-2 focus:ring-[#BC955B] focus:border-[#BC955B] dark:focus:ring-[#d4a762] dark:focus:border-[#d4a762] transition-colors" />
                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-[#691831] dark:text-[#c44569]">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
                  </svg>
                </div>
              </div>
            </div>

            <div class="flex flex-col justify-end space-y-3">
              <label class="flex items-center space-x-2 cursor-pointer">
                <div class="relative">
                  <input type="checkbox" [(ngModel)]="globalCaseSensitive" class="sr-only peer" />
                  <div
                    class="w-11 h-6 rounded-full transition-colors bg-gray-300 dark:bg-neutral-600 peer-checked:bg-[#691831] dark:peer-checked:bg-[#c44569]">
                  </div>
                  <div
                    class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5">
                  </div>
                </div>
                <span class="text-sm text-gray-700 dark:text-gray-300 dark:text-gray-300 font-medium">Coincidir
                  mayusculas</span>
              </label>

              <button (click)="performGlobalSearch()" [disabled]="!globalSearchTerm.trim() || isGlobalSearching()"
                class="w-full py-3 border-2  bg-[#691831] text-white dark:bg-[#c44569] font-bold rounded-xl  hover:border-[#A02142] dark:hover:border-[#d4708a] disabled:border-gray-300 disabled:bg-gray-300 flex items-center justify-center space-x-2">
                <span *ngIf="!isGlobalSearching()">Buscar en todos</span>
                <span *ngIf="isGlobalSearching()" class="flex items-center space-x-2">
                  <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  <span>Buscando...</span>
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- Results -->
        <div *ngIf="globalSearchResults">
          <div class="p-6 bg-[#691831] text-white dark:bg-[#c44569] rounded-xl mb-6 shadow-sm">
            <div class="flex justify-between items-center">
              <h3 class="font-bold text-xl">
                "{{ globalSearchResults.term }}" - {{ globalSearchResults.total_matches }} coincidencias en {{
                globalSearchResults.total_documents_with_matches }} documentos
              </h3>
              <span class="text-sm font-semibold bg-white/20 px-4 py-2 rounded-full">{{
                globalSearchResults.execution_time | number:'1.3-3' }}s</span>
            </div>
          </div>

          <div *ngIf="globalSearchResults.documents.length === 0"
            class="text-center py-16 bg-white rounded-xl shadow-sm">
            <div class="w-24 h-24 mx-auto mb-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
              <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m6 4.125l2.25 2.25m0 0l2.25 2.25M12 13.875l2.25-2.25M12 13.875l-2.25 2.25M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
              </svg>
            </div>
            <p class="text-gray-700 font-semibold text-lg">No se encontraron coincidencias en ningun documento.</p>
            <p class="text-sm text-gray-500 mt-2">Intenta con otros terminos de busqueda</p>
          </div>

          <div *ngIf="globalSearchResults.documents.length > 0" class="space-y-5">
            <div *ngFor="let doc of globalSearchResults.documents"
              class="bg-white dark:bg-[#1a1a1b] border-2 border-gray-200 rounded-xl overflow-hidden hover:shadow-lg hover: transition-all">
              <div
                class="bg-[#691831] text-white dark:bg-[#c44569] p-6 flex justify-between items-center cursor-pointer hover:bg-[#A02142] transition-all"
                (click)="goToDocumentSearch(doc.pdf_id, doc.filename || doc.pdf_id)">
                <div>
                  <h4 class="font-bold text-xl mb-2">{{ doc.filename || doc.pdf_id }}</h4>
                  <div class="flex items-center space-x-4">
                    <span class="inline-flex items-center px-3 py-1 text-xs font-bold bg-white/20 rounded-full">{{
                      doc.total_matches }} coincidencias</span>
                    <span class="text-sm text-white/70">ID: {{ doc.pdf_id.substring(0, 16) }}...</span>
                  </div>
                </div>
                <span
                  class="inline-flex items-center px-5 py-3 bg-white dark:bg-[#1a1a1b] text-blue-500 font-bold rounded-xl hover:bg-[#691831]/10 dark:border-[#c44569] dark:text-[#c44569] dark:hover:bg-[#c44569]/20 transition-all">
                  <span>Ver documento</span>
                  <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                  </svg>
                </span>
              </div>

              <div class="p-6 bg-gray-50 dark:bg-[#131314]  max-h-72 overflow-y-auto">
                <div class="space-y-3">
                  <div *ngFor="let result of doc.results.slice(0, 5)"
                    class="p-4 bg-white border-2 border-gray-200 rounded-xl hover: transition-all">
                    <span
                      class="inline-flex items-center px-3 py-1 text-xs font-bold border-2 border-[#691831] text-[#691831] rounded-full mr-3">
                      Pagina {{ result.page }}
                    </span>
                    <span class="text-gray-800 dark:text-gray-200">
                      ...<span
                        class="bg-[#BC955B]/30 text-[#691831] dark:bg-[#BC955B]/20 dark:text-[#f1c27d] px-1.5 py-0.5 rounded font-semibold">{{
                        result.context }}</span>...
                    </span>
                  </div>
                  <div *ngIf="doc.results.length > 5" class="text-center text-sm text-gray-600 dark:text-gray-400 pt-3">
                    <span
                      class="inline-flex items-center px-4 py-2 border-2 border-[#691831] text-[#691831] rounded-full font-semibold">
                      ... y {{ doc.results.length - 5 }} coincidencias mas
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FILES SECTION -->
    <section *ngIf="activeTab === 'files'" class="space-y-6">
      <!-- View Toggle and Title -->
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-[#691831] dark:text-[#c44569]">PDFs Almacenados ({{ totalPdfsCount }})</h2>
        <div class="flex items-center space-x-2 bg-gray-50 dark:bg-[#131314]  rounded-lg p-1">
          <button (click)="viewMode = 'cards'"
            [class]="viewMode === 'cards' ? 'bg-[#691831] text-white dark:bg-[#c44569]' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-neutral-800'"
            class="px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center space-x-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
            </svg>
            <span>Cards</span>
          </button>
          <button (click)="viewMode = 'table'"
            [class]="viewMode === 'table' ? 'bg-[#691831] text-white dark:bg-[#c44569]' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-neutral-800'"
            class="px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center space-x-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
            </svg>
            <span>Tabla</span>
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="pdfsList.length === 0" class="text-center py-16 bg-gray-50 dark:bg-[#131314]  rounded-xl">
        <div class="w-24 h-24 mx-auto mb-4 border-2 border-gray-300 rounded-full flex items-center justify-center">
          <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5" />
          </svg>
        </div>
        <p class="text-gray-600 dark:text-gray-400 font-medium text-lg">No hay PDFs almacenados</p>
        <p class="text-sm text-gray-500 mt-2">Sube tu primer PDF para comenzar</p>
        <button (click)="activeTab = 'upload'"
          class="mt-4 px-6 py-3 bg-[#691831] text-white dark:bg-[#c44569] font-semibold rounded-xl hover:bg-[#A02142] transition-colors">
          Subir PDF
        </button>
      </div>

      <!-- Cards View -->
      <div *ngIf="pdfsList.length > 0 && viewMode === 'cards'"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div *ngFor="let pdf of pdfsList"
          class="group bg-gray-50 dark:bg-[#131314]  rounded-xl p-5 hover:bg-gray-100 dark:bg-neutral-800 transition-all cursor-pointer"
          (contextmenu)="onContextMenu($event, pdf)">

          <!-- Preview del PDF en Cards -->
          <div class="mb-4 bg-white rounded-lg border border-gray-200 dark:border-neutral-700 p-3">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium text-gray-500">Vista Previa</span>
              <span class="text-xs text-gray-400">{{ pdf.pages }} páginas</span>
            </div>
            <div
              class="h-32 overflow-hidden rounded bg-gradient-to-br from-gray-50 to-gray-100 p-3 border border-gray-300">
              <div class="flex items-start space-x-2 h-full">
                <!-- Icono PDF -->
                <div class="w-8 h-8 flex-shrink-0">
                  <svg class="w-full h-full text-red-500" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8" />
                  </svg>
                </div>
                <!-- Contenido de preview -->
                <div class="flex-1 overflow-hidden">
                  <div class="text-xs font-medium text-gray-700 truncate">{{ pdf.filename }}</div>
                  <div class="mt-1 space-y-1">
                    <div class="h-1.5 w-full bg-gray-300 rounded"></div>
                    <div class="h-1.5 w-3/4 bg-gray-300 rounded"></div>
                    <div class="h-1.5 w-5/6 bg-gray-300 rounded"></div>
                    <div class="h-1.5 w-2/3 bg-gray-300 rounded"></div>
                    <div class="h-1.5 w-4/5 bg-gray-300 rounded"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-between items-start mb-3">
            <div class="flex-1 min-w-0">
              <h4
                class="font-bold text-gray-900 dark:text-gray-100 truncate group-hover:text-[#691831] dark:group-hover:text-[#c44569]"
                [title]="pdf.filename">{{
                pdf.filename }}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ formatBytes(pdf.size) }}</p>
            </div>
          </div>

          <div class="flex items-center justify-between mb-3">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold" [ngClass]="{
            'bg-[#691831]/10 text-[#691831] dark:bg-[#c44569]/20 dark:text-[#c44569]': pdf.status === 'completed',
            'bg-yellow-100 text-yellow-800': pdf.status === 'processing',
            'bg-gray-100 dark:bg-neutral-800 text-gray-800 dark:text-gray-200': pdf.status === 'pending',
            'bg-red-100 text-red-800': pdf.status === 'failed'
          }">
              {{ pdf.status === 'completed' ? 'Completado' : pdf.status === 'processing' ? 'Procesando' : pdf.status ===
              'pending' ? 'Pendiente' : 'Error' }}
            </span>
          </div>

          <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
            <div class="h-2 rounded-full transition-all" [ngClass]="{
            'bg-[#691831] dark:bg-[#c44569]': pdf.status === 'completed',
            'bg-yellow-500': pdf.status === 'processing',
            'bg-gray-500': pdf.status === 'pending',
            'bg-red-500': pdf.status === 'failed'
          }" [style.width.%]="pdf.progress"></div>
          </div>

          <div class="flex space-x-2">
            <button (click)="$event.stopPropagation(); viewText(pdf.id)"
              class="flex-1 px-3 py-2 text-sm bg-[#691831] text-white dark:bg-[#c44569] rounded-lg hover:bg-[#A02142] transition-colors font-medium"
              [disabled]="pdf.status !== 'completed'">
              Ver
            </button>
            <button (click)="$event.stopPropagation(); downloadText(pdf.id)"
              class="flex-1 px-3 py-2 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium"
              [disabled]="pdf.status !== 'completed'">
              TXT
            </button>
            <button (click)="$event.stopPropagation(); irAlExplorador(pdf)"
              class="flex-1 px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
              PDF
            </button>
            <button (click)="$event.stopPropagation(); deletePdf(pdf.id, pdf.filename)"
              class="px-3 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Table View -->
      <div *ngIf="pdfsList.length > 0 && viewMode === 'table'" class="bg-gray-50 rounded-xl overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100 dark:bg-neutral-800">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Preview</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Paginas</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tamano</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estado</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-gray-50 dark:bg-[#131314] divide-y divide-gray-200 dark:divide-neutral-700">
            <tr *ngFor="let pdf of pdfsList" class="hover:bg-gray-100 dark:bg-neutral-800 cursor-pointer"
              (contextmenu)="onContextMenu($event, pdf)">
              <!-- Preview del PDF en Table -->
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div
                    class="w-16 h-20 flex-shrink-0 bg-gradient-to-br from-gray-100 to-gray-200 rounded border border-gray-300 p-2">
                    <div class="flex flex-col items-center justify-center h-full">
                      <svg class="w-6 h-6 text-red-500 mb-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z M14 2v6h6" />
                      </svg>
                      <div class="text-xs text-gray-600 dark:text-gray-400 font-medium">PDF</div>
                      <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ pdf.pages }}p</div>
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900 dark:text-gray-100 max-w-xs truncate"
                  [title]="pdf.filename">{{ pdf.filename
                  }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ pdf.pages }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ formatBytes(pdf.size)
                }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" [ngClass]="{
                'bg-[#691831]/10 text-[#691831] dark:bg-[#c44569]/20 dark:text-[#c44569]': pdf.status === 'completed',
                'bg-yellow-100 text-yellow-800': pdf.status === 'processing',
                'bg-gray-100 dark:bg-neutral-800 text-gray-800 dark:text-gray-200': pdf.status === 'pending',
                'bg-red-100 text-red-800': pdf.status === 'failed'
              }">
                  {{ pdf.status === 'completed' ? 'Completado' : pdf.status === 'processing' ? 'Procesando' : pdf.status
                  === 'pending' ? 'Pendiente' : 'Error' }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end space-x-2">
                  <button (click)="$event.stopPropagation(); viewText(pdf.id)"
                    class="px-3 py-1.5 text-xs bg-[#691831] text-white dark:bg-[#c44569] rounded-lg hover:bg-[#A02142] transition-colors font-medium"
                    [disabled]="pdf.status !== 'completed'">
                    Ver
                  </button>
                  <button (click)="$event.stopPropagation(); downloadText(pdf.id)"
                    class="px-3 py-1.5 text-xs bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium"
                    [disabled]="pdf.status !== 'completed'">
                    TXT
                  </button>
                  <button (click)="$event.stopPropagation(); irAlExplorador(pdf)"
                    class="px-3 py-1.5 text-xs bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    PDF
                  </button>
                  <button (click)="$event.stopPropagation(); deletePdf(pdf.id, pdf.filename)"
                    class="px-3 py-1.5 text-xs bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium">
                    Eliminar
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section *ngIf="activeTab === 'lotes'" class="space-y-6">

      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">
        Procesos de carga masiva
      </h3>

      <!-- Loading -->
        <!-- Skeleton -->
        <div *ngIf="isLoadingLotes()"
            class="bg-gray-50 dark:bg-[#131314] rounded-xl overflow-hidden shadow-sm animate-pulse">

          <table class="min-w-full">
            <thead class="bg-gray-100 dark:bg-neutral-800">
              <tr>
                <th *ngFor="let i of [1,2,3,4,5,6,7]"
                    class="px-6 py-3">
                  <div class="h-3 w-20 bg-gray-300 dark:bg-neutral-700 rounded"></div>
                </th>
              </tr>
            </thead>

            <tbody class="divide-y divide-gray-200 dark:divide-neutral-700">
              <tr *ngFor="let row of [1,2,3,4,5]"
                  class="dark:bg-neutral-800">
                <td *ngFor="let col of [1,2,3,4,5,6,7]"
                    class="px-6 py-4">
                  <div class="h-4 bg-gray-300 dark:bg-neutral-700 rounded w-full"></div>
                </td>
              </tr>
            </tbody>
          </table>
      </div>

      <!-- Table -->
      <div *ngIf="!isLoadingLotes() && lotesUsuario().length > 0"
        class="bg-gray-50 dark:bg-[#131314] rounded-xl overflow-visible shadow-sm">

        <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700"   [class.opacity-50]="isLoadingLotes()">
          <thead class="bg-gray-100 dark:bg-neutral-800">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider
               text-gray-700 dark:text-gray-300">Lote</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider
               text-gray-700 dark:text-gray-300">Archivos</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider
               text-gray-700 dark:text-gray-300">Completados</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider
               text-gray-700 dark:text-gray-300">Progreso</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider
               text-gray-700 dark:text-gray-300">Último proceso</th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider
 text-gray-700 dark:text-gray-300">
                Estado
              </th>
              <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider
            text-gray-700 dark:text-gray-300">
                Tipo
              </th>

            </tr>
          </thead>

          <tbody class="bg-gray-50 dark:bg-[#131314] divide-y divide-gray-200 dark:divide-neutral-700">
            <ng-container *ngFor="let lote of lotesUsuario()">
              <tr class="transition-colors hover:bg-gray-100 dark:hover:bg-neutral-700 dark:bg-neutral-800">

                <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-gray-100">
                  {{ lote.loteId }}
                </td>

                <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
                  {{ lote.totalArchivos }}
                </td>

                <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
                  <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                    <!-- <span>{{ lote.completados }} / {{ lote.totalArchivos }}</span> -->
                    <span class="font-semibold">
                      {{ lote.completados }} / {{ lote.totalArchivos }}
                    </span>

                  </div>

                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-col space-y-1">

                    <!-- Barra -->
                    <!-- Barra -->
                    <div class="flex items-center space-x-3 relative group">

                      <div class="w-full bg-gray-200 dark:bg-neutral-700 rounded-full h-2">
                        <div
                          class="h-2 rounded-full transition-all"
                          [ngClass]="{
                            'bg-green-500': getProgresoReal(lote) === 100 && (lote?.fallados ?? 0) === 0,
                            'bg-red-500': (lote?.fallados ?? 0) > 0,
                            'bg-yellow-500': getProgresoReal(lote) < 100 && (lote?.fallados ?? 0) === 0
                          }"
                          [style.width.%]="getProgresoReal(lote)">
                        </div>
                      </div>

                      <!-- Porcentaje visible -->
                      <span class="text-xs font-medium text-gray-700 dark:text-gray-300 min-w-[40px] cursor-pointer">
                        {{ getProgresoReal(lote) }}%
                      </span>

                      <!-- Tooltip -->
                      <div *ngIf="getProgresoReal(lote) < 100"
                          class="absolute bottom-8 left-1/2 -translate-x-1/2 
                                  opacity-0 group-hover:opacity-100 
                                  transition-all duration-200 
                                  bg-gray-800 text-white text-xs 
                                  px-3 py-2 rounded-lg shadow-lg 
                                  whitespace-nowrap z-50">

                        <div class="flex items-center gap-2">
                          <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"
                              stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="9"></circle>
                            <path d="M12 7v5l3 3"></path>
                          </svg>

                          <span>
                            Procesando {{ lote.paginasTotales }} páginas<br>
                            {{ estimarTiempoRestante(lote) }}
                          </span>
                        </div>
                      </div>

                    </div>
                    <!-- Mensaje de error con tooltip -->
                    <div *ngIf="(lote?.fallados ?? 0) > 0"
                      class="relative group text-xs text-red-600 dark:text-red-400 flex items-center gap-1 ">

                      <!-- Icono alerta -->
                      <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 9v4"></path>
                        <path d="M12 17h.01"></path>
                        <path d="M10.29 3.86l-7.1 12.28A2 2 0 005 19h14a2 2 0 001.81-2.86l-7.1-12.28a2 2 0 00-3.42 0z">
                        </path>
                      </svg>

                      <span>
                        {{ lote?.fallados }} archivo(s) con error
                      </span>

                      <!-- Tooltip -->
                      <div class="absolute z-[9999] hidden group-hover:block
                  top-full left-0 mt-2 w-80
                  bg-gray-900 text-white text-xs
                  rounded-lg shadow-lg p-3">

                        <ul class="list-disc pl-4 space-y-1">
                          <li *ngFor="let error of lote?.errores">
                            {{ error }}
                          </li>
                        </ul>
                      </div>
                    </div>


                  </div>
                </td>


                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                  {{ formatDate(lote.ultimoProceso) }}
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" [ngClass]="{
      'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300': lote.porcentaje === 100 && lote.fallados === 0,
      'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300': lote.fallados > 0,
      'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300': lote.porcentaje < 100 && lote.fallados === 0
    }">
                    <ng-container *ngIf="lote.porcentaje === 100 && lote.fallados === 0">
                      Completado
                    </ng-container>
                    <ng-container *ngIf="lote.fallados > 0">
                      Con errores
                    </ng-container>
                    <ng-container *ngIf="lote.porcentaje < 100 && lote.fallados === 0">
                      En proceso
                    </ng-container>
                  </span>
                </td>
                <td class="px-6 py-4 text-sm">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="{
                    'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300': lote.tipoProceso === 'OCR',
                    'bg-gray-200 text-gray-700 dark:bg-neutral-700 dark:text-gray-300': lote.tipoProceso === 'NORMAL'
                  }">
                    {{ lote.tipoProceso }}
                  </span>
                </td>


              </tr>


              <!-- Fila extra: archivos procesados -->
              <tr *ngIf="lote.porcentaje === 100 && lote.archivosProcesados.length"
                class="bg-white dark:bg-neutral-900">
                <td colspan="7" class="px-6 py-4">
                  <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-green-700 dark:text-green-400 flex items-center gap-2">
                      <!-- Icono documento -->
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                        <path d="M14 2v6h6"></path>
                      </svg>
                      <span>Archivos procesados</span>
                    </h4>
                    <ul class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                      <li *ngFor="let archivo of lote.archivosProcesados" class="flex items-center justify-between p-2 rounded-lg
                              bg-gray-50 dark:bg-neutral-800">

                        <div class="flex flex-col">

                          <a *ngIf="buildExploradorUrl(archivo.nombreArchivo) as url" [href]="url" target="_blank"
                            class="font-medium text-blue-600 hover:underline hover:text-blue-800 transition">
                            {{ archivo.nombreArchivo }}
                          </a>

                          <!-- Si no se puede parsear -->
                          <span *ngIf="!buildExploradorUrl(archivo.nombreArchivo)" class="font-medium text-gray-700">
                            {{ archivo.nombreArchivo }}
                          </span>

                          <span class="text-xs text-gray-500">
                            Documento ID: {{ archivo.metadata?.documentoId ?? '—' }}
                          </span>
                        </div>

                        <span class="flex items-center gap-1 text-xs text-green-600 font-semibold">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 13l4 4L19 7"></path>
                          </svg> Procesado </span>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>

            </ng-container>

          </tbody>
        </table>
      </div>

      <!-- Empty state -->
      <div *ngIf="!isLoadingLotes() && lotesUsuario().length === 0" class="text-center text-gray-500 dark:text-gray-400 py-8">
        No hay lotes registrados.
      </div>

    </section>

  </main>
</div>

<!-- Context Menu -->
<div *ngIf="showContextMenu"
  class="fixed z-50 bg-white rounded-lg shadow-xl border border-gray-200 dark:border-neutral-700 py-2 min-w-48"
  [style.left.px]="contextMenuX" [style.top.px]="contextMenuY" (mouseleave)="closeContextMenu()">
  <button (click)="viewText(contextMenuPdf?.id); closeContextMenu()"
    class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:bg-neutral-800 flex items-center space-x-3">
    <svg class="w-4 h-4 text-[#691831] dark:text-[#c44569]" fill="none" stroke="currentColor" stroke-width="2"
      viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
    <span>Ver texto</span>
  </button>
  <button (click)="downloadText(contextMenuPdf?.id); closeContextMenu()"
    class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:bg-neutral-800 flex items-center space-x-3">
    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
    </svg>
    <span>Descargar TXT</span>
  </button>
  <button (click)="downloadSearchablePDF(contextMenuPdf?.id); closeContextMenu()"
    class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:bg-neutral-800 flex items-center space-x-3">
    <svg class="w-4 h-4 text-[#691831] dark:text-[#c44569]" fill="none" stroke="currentColor" stroke-width="2"
      viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
    </svg>
    <span>Descargar PDF con texto</span>
  </button>
  <button (click)="selectedPdfId = contextMenuPdf?.id; activeTab = 'search'; closeContextMenu()"
    class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:bg-neutral-800 flex items-center space-x-3">
    <svg class="w-4 h-4 text-[#691831] dark:text-[#c44569]" fill="none" stroke="currentColor" stroke-width="2"
      viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
    </svg>
    <span>Buscar en documento</span>
  </button>
  <div class="border-t border-gray-200 dark:border-neutral-700 my-1"></div>
  <button (click)="deletePdf(contextMenuPdf?.id, contextMenuPdf?.filename); closeContextMenu()"
    class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center space-x-3">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
    </svg>
    <span>Eliminar</span>
  </button>
</div>

<!-- Click overlay to close context menu -->
<div *ngIf="showContextMenu" class="fixed inset-0 z-40" (click)="closeContextMenu()"></div>

<!-- Modal para visualizar texto -->
<div *ngIf="showTextModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
  (click)="closeTextModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col"
    (click)="$event.stopPropagation()">
    <div class="bg-[#691831] text-white dark:bg-[#c44569] p-6 rounded-t-xl flex justify-between items-center">
      <div>
        <h3 class="text-xl font-bold">Texto Extraido del PDF</h3>
        <p class="text-sm text-white/80 mt-1">{{ selectedPdfFilename() }}</p>
      </div>
      <button (click)="closeTextModal()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="p-6 overflow-y-auto flex-1 bg-gray-50 dark:bg-neutral-900">
      <div class="bg-white dark:bg-[#131314] rounded-xl p-6 border border-gray-200  dark:border-neutral-700">
        <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200 dark:border-neutral-700">
          <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-400">
            <span class="flex items-center space-x-2">
              <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
              </svg>
              <span class="font-medium">{{ textContentLines }} lineas</span>
            </span>
            <span class="flex items-center space-x-2">
              <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" />
              </svg>
              <span class="font-medium">{{ textContentLength }} caracteres</span>
            </span>
          </div>
        </div>
        <pre
          class="whitespace-pre-wrap text-sm text-gray-800 dark:text-gray-200 leading-relaxed font-mono">{{ pdfTextContent }}</pre>
      </div>
    </div>

    <div class="p-4 bg-gray-100 dark:bg-neutral-800 rounded-b-xl flex justify-end">
      <button (click)="closeTextModal()"
        class="px-6 py-3 border-2  bg-[#691831] text-white dark:bg-[#c44569] font-semibold rounded-xl  hover:border-[#A02142] dark:hover:border-[#d4708a] transition-all">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Spinner -->
<!-- <ngx-spinner bdColor="rgba(0,0,0,0.8)" size="large" color="#3B82F6" type="ball-scale-multiple" [fullScreen]="true">
  <p class="text-white font-semibold text-lg mt-4">{{ loadingMessage() }}</p>
</ngx-spinner> -->
